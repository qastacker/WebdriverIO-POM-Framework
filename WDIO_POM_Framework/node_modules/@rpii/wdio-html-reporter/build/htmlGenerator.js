"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

const Handlebars = require('handlebars');

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const base64Img = require('base64-img');

const logger = require('@log4js-node/log4js-api');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlGenerator {
  static htmlOutput(reportOptions, callback = () => {}) {
    try {
      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation started");
      }

      let templateFile = fs.readFileSync(reportOptions.templateFilename, 'utf8');
      Handlebars.registerHelper('imageAsBase64', function (screenshotFile, screenshotPath, hbopts) {
        // occurs when there is an error file
        if (!fs.existsSync(screenshotFile)) {
          if (screenshotPath) {
            screenshotFile = `${screenshotPath}/${screenshotFile}`;
          } else {
            screenshotFile = `${screenshotFile}`;
          }
        }

        const data = base64Img.base64Sync(path.resolve(`${screenshotFile}`));
        return `${data}`;
      });
      Handlebars.registerHelper('isValidReport', function (suites, hbopts) {
        if (suites && suites.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('isValidSuite', function (suite, hbopts) {
        if (suite.title.length > 0 && suite.type === 'suite' && suite.tests.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('testStateColour', function (state, hbopts) {
        if (state === 'passed') {
          return 'test-pass';
        } else if (state === 'failed') {
          return 'test-fail';
        } else if (state === 'pending') {
          return 'test-pending';
        } else if (state === 'skipped') {
          return 'test-skipped';
        }
      });
      Handlebars.registerHelper('testStateIcon', function (state, hbopts) {
        if (state === 'passed') {
          return '<span class="success">&#10004;</span>';
        } else if (state === 'failed') {
          return '<span class="error">&#10006;</span>';
        } else if (state === 'pending') {
          return '<span class="pending">&#10004;</span>';
        } else if (state === 'skipped') {
          return '<span class="skipped">&#10034;</span>';
        }
      });
      Handlebars.registerHelper('suiteStateColour', function (tests, hbopts) {
        let numTests = Object.keys(tests).length;

        let fail = _.values(tests).find(test => {
          return test.state === 'failed';
        });

        if (fail != null) {
          return 'suite-fail';
        }

        let passes = _.values(tests).filter(test => {
          return test.state === 'passed';
        });

        if (passes.length === numTests && numTests > 0) {
          return 'suite-pass';
        } //skipped is the lowest priority check


        let skipped = _.values(tests).find(test => {
          return test.state === 'skipped';
        });

        if (skipped != null) {
          return 'suite-pending';
        }

        return 'suite-unknown';
      });
      Handlebars.registerHelper('humanizeDuration', function (duration, hbopts) {
        return moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
          trim: false
        });
      });
      Handlebars.registerHelper('ifSuiteHasTests', function (testsHash, hbopts) {
        if (Object.keys(testsHash).length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsError', function (event, hbopts) {
        if (event.type.includes('Error')) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsScreenshot', function (event, hbopts) {
        if (event.type === 'screenshot') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsLogMessage', function (event, hbopts) {
        if (event.type === 'log') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('logClass', function (text, hbopts) {
        if (text.includes('Test Iteration')) {
          return "test-iteration";
        } else {
          return "log-output";
        }
      });
      Object.keys(reportOptions.templateFuncs).forEach(key => {
        Handlebars.registerHelper(key, reportOptions.templateFuncs[key]);
      });

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        let jsonFile = reportOptions.reportFile.replace('.html', '.json');
        fs.outputFileSync(jsonFile, JSON.stringify(reportOptions.data));
      }

      let template = Handlebars.compile(templateFile);
      let html = template(reportOptions.data);

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        fs.outputFileSync(reportOptions.reportFile, html);
      }

      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation completed");
      }

      callback(true);
    } catch (ex) {
      if (reportOptions.LOG) {
        reportOptions.LOG.error("Html Generation processing ended in error: " + ex);
      }

      callback(false);
    }
  }

}

var _default = HtmlGenerator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odG1sR2VuZXJhdG9yLmpzIl0sIm5hbWVzIjpbIkhhbmRsZWJhcnMiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aCIsIm1vbWVudCIsImJhc2U2NEltZyIsImxvZ2dlciIsIm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAiLCJIdG1sR2VuZXJhdG9yIiwiaHRtbE91dHB1dCIsInJlcG9ydE9wdGlvbnMiLCJjYWxsYmFjayIsIkxPRyIsImRlYnVnIiwidGVtcGxhdGVGaWxlIiwicmVhZEZpbGVTeW5jIiwidGVtcGxhdGVGaWxlbmFtZSIsInJlZ2lzdGVySGVscGVyIiwic2NyZWVuc2hvdEZpbGUiLCJzY3JlZW5zaG90UGF0aCIsImhib3B0cyIsImV4aXN0c1N5bmMiLCJkYXRhIiwiYmFzZTY0U3luYyIsInJlc29sdmUiLCJzdWl0ZXMiLCJsZW5ndGgiLCJmbiIsImludmVyc2UiLCJzdWl0ZSIsInRpdGxlIiwidHlwZSIsInRlc3RzIiwic3RhdGUiLCJudW1UZXN0cyIsIk9iamVjdCIsImtleXMiLCJmYWlsIiwidmFsdWVzIiwiZmluZCIsInRlc3QiLCJwYXNzZXMiLCJmaWx0ZXIiLCJza2lwcGVkIiwiZHVyYXRpb24iLCJmb3JtYXQiLCJ0cmltIiwidGVzdHNIYXNoIiwiZXZlbnQiLCJpbmNsdWRlcyIsInRleHQiLCJ0ZW1wbGF0ZUZ1bmNzIiwiZm9yRWFjaCIsImtleSIsInBhdGhFeGlzdHNTeW5jIiwib3V0cHV0RGlyIiwianNvbkZpbGUiLCJyZXBvcnRGaWxlIiwicmVwbGFjZSIsIm91dHB1dEZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsInRlbXBsYXRlIiwiY29tcGlsZSIsImh0bWwiLCJleCIsImVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSxNQUFNQSxVQUFVLEdBQUdDLE9BQU8sQ0FBQyxZQUFELENBQTFCOztBQUNBLE1BQU1DLEVBQUUsR0FBR0QsT0FBTyxDQUFDLFVBQUQsQ0FBbEI7O0FBQ0EsTUFBTUUsQ0FBQyxHQUFHRixPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNRyxJQUFJLEdBQUdILE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1JLE1BQU0sR0FBR0osT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBQ0EsTUFBTUssU0FBUyxHQUFHTCxPQUFPLENBQUMsWUFBRCxDQUF6Qjs7QUFDQSxNQUFNTSxNQUFNLEdBQUdOLE9BQU8sQ0FBQyx5QkFBRCxDQUF0Qjs7QUFFQSxNQUFNTyx5QkFBeUIsR0FBR1AsT0FBTyxDQUFDLHdCQUFELENBQXpDOztBQUNBTyx5QkFBeUIsQ0FBQ0gsTUFBRCxDQUF6Qjs7QUFFQSxNQUFNSSxhQUFOLENBQXFCO0FBRWpCLFNBQU9DLFVBQVAsQ0FBa0JDLGFBQWxCLEVBQWlDQyxRQUFRLEdBQUcsTUFBSyxDQUFFLENBQW5ELEVBQXFEO0FBQ2pELFFBQUk7QUFDQSxVQUFJRCxhQUFhLENBQUNFLEdBQWxCLEVBQXVCO0FBQ25CRixRQUFBQSxhQUFhLENBQUNFLEdBQWQsQ0FBa0JDLEtBQWxCLENBQXdCLHlCQUF4QjtBQUNIOztBQUNELFVBQUlDLFlBQVksR0FBR2IsRUFBRSxDQUFDYyxZQUFILENBQWdCTCxhQUFhLENBQUNNLGdCQUE5QixFQUFnRCxNQUFoRCxDQUFuQjtBQUVBakIsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixlQUExQixFQUEyQyxVQUFVQyxjQUFWLEVBQTBCQyxjQUExQixFQUEwQ0MsTUFBMUMsRUFBa0Q7QUFDekY7QUFDQSxZQUFJLENBQUNuQixFQUFFLENBQUNvQixVQUFILENBQWNILGNBQWQsQ0FBTCxFQUFvQztBQUNoQyxjQUFJQyxjQUFKLEVBQW9CO0FBQ2hCRCxZQUFBQSxjQUFjLEdBQUksR0FBRUMsY0FBZSxJQUFHRCxjQUFlLEVBQXJEO0FBQ0gsV0FGRCxNQUVPO0FBQ0hBLFlBQUFBLGNBQWMsR0FBSSxHQUFFQSxjQUFlLEVBQW5DO0FBQ0g7QUFDSjs7QUFDRCxjQUFNSSxJQUFJLEdBQUdqQixTQUFTLENBQUNrQixVQUFWLENBQXFCcEIsSUFBSSxDQUFDcUIsT0FBTCxDQUFjLEdBQUVOLGNBQWUsRUFBL0IsQ0FBckIsQ0FBYjtBQUNBLGVBQVEsR0FBRUksSUFBSyxFQUFmO0FBQ0gsT0FYRDtBQVlBdkIsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixlQUExQixFQUEyQyxVQUFVUSxNQUFWLEVBQWtCTCxNQUFsQixFQUEwQjtBQUNqRSxZQUFJSyxNQUFNLElBQUlBLE1BQU0sQ0FBQ0MsTUFBUCxHQUFnQixDQUE5QixFQUFrQztBQUM5QixpQkFBT04sTUFBTSxDQUFDTyxFQUFQLENBQVUsSUFBVixDQUFQO0FBQ0g7O0FBQ0QsZUFBT1AsTUFBTSxDQUFDUSxPQUFQLENBQWUsSUFBZixDQUFQO0FBQ0gsT0FMRDtBQU1BN0IsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixjQUExQixFQUEwQyxVQUFVWSxLQUFWLEVBQWlCVCxNQUFqQixFQUF5QjtBQUMvRCxZQUFJUyxLQUFLLENBQUNDLEtBQU4sQ0FBWUosTUFBWixHQUFxQixDQUFyQixJQUNBRyxLQUFLLENBQUNFLElBQU4sS0FBZSxPQURmLElBRUFGLEtBQUssQ0FBQ0csS0FBTixDQUFZTixNQUFaLEdBQXFCLENBRnpCLEVBRTZCO0FBQ3pCLGlCQUFPTixNQUFNLENBQUNPLEVBQVAsQ0FBVSxJQUFWLENBQVA7QUFDSDs7QUFDRCxlQUFPUCxNQUFNLENBQUNRLE9BQVAsQ0FBZSxJQUFmLENBQVA7QUFDSCxPQVBEO0FBU0E3QixNQUFBQSxVQUFVLENBQUNrQixjQUFYLENBQTBCLGlCQUExQixFQUE2QyxVQUFVZ0IsS0FBVixFQUFpQmIsTUFBakIsRUFBeUI7QUFDbEUsWUFBSWEsS0FBSyxLQUFLLFFBQWQsRUFBd0I7QUFDcEIsaUJBQU8sV0FBUDtBQUNILFNBRkQsTUFFTyxJQUFJQSxLQUFLLEtBQUssUUFBZCxFQUF3QjtBQUMzQixpQkFBTyxXQUFQO0FBQ0gsU0FGTSxNQUVBLElBQUlBLEtBQUssS0FBSyxTQUFkLEVBQXlCO0FBQzVCLGlCQUFPLGNBQVA7QUFDSCxTQUZNLE1BRUEsSUFBSUEsS0FBSyxLQUFLLFNBQWQsRUFBeUI7QUFDaEMsaUJBQU8sY0FBUDtBQUNIO0FBQ0EsT0FWRDtBQVlBbEMsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixlQUExQixFQUEyQyxVQUFVZ0IsS0FBVixFQUFpQmIsTUFBakIsRUFBeUI7QUFDaEUsWUFBSWEsS0FBSyxLQUFLLFFBQWQsRUFBd0I7QUFDcEIsaUJBQU8sdUNBQVA7QUFDSCxTQUZELE1BRU8sSUFBSUEsS0FBSyxLQUFLLFFBQWQsRUFBd0I7QUFDM0IsaUJBQU8scUNBQVA7QUFDSCxTQUZNLE1BRUEsSUFBSUEsS0FBSyxLQUFLLFNBQWQsRUFBeUI7QUFDNUIsaUJBQU8sdUNBQVA7QUFDSCxTQUZNLE1BRUEsSUFBSUEsS0FBSyxLQUFLLFNBQWQsRUFBeUI7QUFDNUIsaUJBQU8sdUNBQVA7QUFDSDtBQUNKLE9BVkQ7QUFZQWxDLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsa0JBQTFCLEVBQThDLFVBQVVlLEtBQVYsRUFBaUJaLE1BQWpCLEVBQXlCO0FBQ25FLFlBQUljLFFBQVEsR0FBR0MsTUFBTSxDQUFDQyxJQUFQLENBQVlKLEtBQVosRUFBbUJOLE1BQWxDOztBQUVBLFlBQUlXLElBQUksR0FBR25DLENBQUMsQ0FBQ29DLE1BQUYsQ0FBU04sS0FBVCxFQUFnQk8sSUFBaEIsQ0FBc0JDLElBQUQsSUFBVTtBQUN0QyxpQkFBT0EsSUFBSSxDQUFDUCxLQUFMLEtBQWUsUUFBdEI7QUFDSCxTQUZVLENBQVg7O0FBR0EsWUFBSUksSUFBSSxJQUFJLElBQVosRUFBa0I7QUFDZCxpQkFBTyxZQUFQO0FBQ0g7O0FBRUQsWUFBSUksTUFBTSxHQUFHdkMsQ0FBQyxDQUFDb0MsTUFBRixDQUFTTixLQUFULEVBQWdCVSxNQUFoQixDQUF3QkYsSUFBRCxJQUFVO0FBQzFDLGlCQUFPQSxJQUFJLENBQUNQLEtBQUwsS0FBZSxRQUF0QjtBQUNILFNBRlksQ0FBYjs7QUFHQSxZQUFJUSxNQUFNLENBQUNmLE1BQVAsS0FBa0JRLFFBQWxCLElBQThCQSxRQUFRLEdBQUcsQ0FBN0MsRUFBZ0Q7QUFDNUMsaUJBQU8sWUFBUDtBQUNILFNBZmtFLENBaUJuRTs7O0FBQ0EsWUFBSVMsT0FBTyxHQUFHekMsQ0FBQyxDQUFDb0MsTUFBRixDQUFTTixLQUFULEVBQWdCTyxJQUFoQixDQUFzQkMsSUFBRCxJQUFVO0FBQ3pDLGlCQUFPQSxJQUFJLENBQUNQLEtBQUwsS0FBZSxTQUF0QjtBQUNILFNBRmEsQ0FBZDs7QUFHQSxZQUFJVSxPQUFPLElBQUksSUFBZixFQUFxQjtBQUNqQixpQkFBTyxlQUFQO0FBQ0g7O0FBRUQsZUFBTyxlQUFQO0FBQ0gsT0ExQkQ7QUE0QkE1QyxNQUFBQSxVQUFVLENBQUNrQixjQUFYLENBQTBCLGtCQUExQixFQUE4QyxVQUFVMkIsUUFBVixFQUFvQnhCLE1BQXBCLEVBQTRCO0FBQ3RFLGVBQU9oQixNQUFNLENBQUN3QyxRQUFQLENBQWdCQSxRQUFoQixFQUEwQixjQUExQixFQUEwQ0MsTUFBMUMsQ0FBaUQsYUFBakQsRUFBZ0U7QUFBQ0MsVUFBQUEsSUFBSSxFQUFFO0FBQVAsU0FBaEUsQ0FBUDtBQUNILE9BRkQ7QUFJQS9DLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsaUJBQTFCLEVBQTZDLFVBQVU4QixTQUFWLEVBQXFCM0IsTUFBckIsRUFBNkI7QUFDdEUsWUFBSWUsTUFBTSxDQUFDQyxJQUFQLENBQVlXLFNBQVosRUFBdUJyQixNQUF2QixHQUFnQyxDQUFwQyxFQUF1QztBQUNuQyxpQkFBT04sTUFBTSxDQUFDTyxFQUFQLENBQVUsSUFBVixDQUFQO0FBQ0g7O0FBQ0QsZUFBT1AsTUFBTSxDQUFDUSxPQUFQLENBQWUsSUFBZixDQUFQO0FBQ0gsT0FMRDtBQVFBN0IsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixnQkFBMUIsRUFBNEMsVUFBVStCLEtBQVYsRUFBaUI1QixNQUFqQixFQUF5QjtBQUNqRSxZQUFJNEIsS0FBSyxDQUFDakIsSUFBTixDQUFXa0IsUUFBWCxDQUFvQixPQUFwQixDQUFKLEVBQWtDO0FBQzlCLGlCQUFPN0IsTUFBTSxDQUFDTyxFQUFQLENBQVUsSUFBVixDQUFQO0FBQ0g7O0FBQ0QsZUFBT1AsTUFBTSxDQUFDUSxPQUFQLENBQWUsSUFBZixDQUFQO0FBQ0gsT0FMRDtBQU9BN0IsTUFBQUEsVUFBVSxDQUFDa0IsY0FBWCxDQUEwQixxQkFBMUIsRUFBaUQsVUFBVStCLEtBQVYsRUFBaUI1QixNQUFqQixFQUF5QjtBQUN0RSxZQUFJNEIsS0FBSyxDQUFDakIsSUFBTixLQUFlLFlBQW5CLEVBQWlDO0FBQzdCLGlCQUFPWCxNQUFNLENBQUNPLEVBQVAsQ0FBVSxJQUFWLENBQVA7QUFDSDs7QUFDRCxlQUFPUCxNQUFNLENBQUNRLE9BQVAsQ0FBZSxJQUFmLENBQVA7QUFDSCxPQUxEO0FBT0E3QixNQUFBQSxVQUFVLENBQUNrQixjQUFYLENBQTBCLHFCQUExQixFQUFpRCxVQUFVK0IsS0FBVixFQUFpQjVCLE1BQWpCLEVBQXlCO0FBQ3RFLFlBQUk0QixLQUFLLENBQUNqQixJQUFOLEtBQWUsS0FBbkIsRUFBMEI7QUFDdEIsaUJBQU9YLE1BQU0sQ0FBQ08sRUFBUCxDQUFVLElBQVYsQ0FBUDtBQUNIOztBQUNELGVBQU9QLE1BQU0sQ0FBQ1EsT0FBUCxDQUFlLElBQWYsQ0FBUDtBQUNILE9BTEQ7QUFPQTdCLE1BQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEIsVUFBMUIsRUFBc0MsVUFBVWlDLElBQVYsRUFBaUI5QixNQUFqQixFQUF5QjtBQUMzRCxZQUFJOEIsSUFBSSxDQUFDRCxRQUFMLENBQWMsZ0JBQWQsQ0FBSixFQUFxQztBQUNqQyxpQkFBTyxnQkFBUDtBQUNILFNBRkQsTUFFTztBQUNILGlCQUFPLFlBQVA7QUFDSDtBQUNKLE9BTkQ7QUFRQWQsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLENBQVkxQixhQUFhLENBQUN5QyxhQUExQixFQUF5Q0MsT0FBekMsQ0FBa0RDLEdBQUQsSUFBTztBQUNwRHRELFFBQUFBLFVBQVUsQ0FBQ2tCLGNBQVgsQ0FBMEJvQyxHQUExQixFQUErQjNDLGFBQWEsQ0FBQ3lDLGFBQWQsQ0FBNEJFLEdBQTVCLENBQS9CO0FBQ0gsT0FGRDs7QUFJQSxVQUFJcEQsRUFBRSxDQUFDcUQsY0FBSCxDQUFrQjVDLGFBQWEsQ0FBQzZDLFNBQWhDLENBQUosRUFBZ0Q7QUFDN0MsWUFBSUMsUUFBUSxHQUFHOUMsYUFBYSxDQUFDK0MsVUFBZCxDQUF5QkMsT0FBekIsQ0FBaUMsT0FBakMsRUFBMkMsT0FBM0MsQ0FBZjtBQUNLekQsUUFBQUEsRUFBRSxDQUFDMEQsY0FBSCxDQUFrQkgsUUFBbEIsRUFBNEJJLElBQUksQ0FBQ0MsU0FBTCxDQUFlbkQsYUFBYSxDQUFDWSxJQUE3QixDQUE1QjtBQUNQOztBQUVELFVBQUl3QyxRQUFRLEdBQUcvRCxVQUFVLENBQUNnRSxPQUFYLENBQW1CakQsWUFBbkIsQ0FBZjtBQUNBLFVBQUlrRCxJQUFJLEdBQUdGLFFBQVEsQ0FBQ3BELGFBQWEsQ0FBQ1ksSUFBZixDQUFuQjs7QUFFQSxVQUFJckIsRUFBRSxDQUFDcUQsY0FBSCxDQUFrQjVDLGFBQWEsQ0FBQzZDLFNBQWhDLENBQUosRUFBZ0Q7QUFDNUN0RCxRQUFBQSxFQUFFLENBQUMwRCxjQUFILENBQWtCakQsYUFBYSxDQUFDK0MsVUFBaEMsRUFBNENPLElBQTVDO0FBQ0g7O0FBQ0QsVUFBSXRELGFBQWEsQ0FBQ0UsR0FBbEIsRUFBdUI7QUFDbkJGLFFBQUFBLGFBQWEsQ0FBQ0UsR0FBZCxDQUFrQkMsS0FBbEIsQ0FBd0IsMkJBQXhCO0FBQ0g7O0FBQ0RGLE1BQUFBLFFBQVEsQ0FBQyxJQUFELENBQVI7QUFDSCxLQWpKRCxDQWlKRSxPQUFNc0QsRUFBTixFQUFVO0FBQ1IsVUFBSXZELGFBQWEsQ0FBQ0UsR0FBbEIsRUFBdUI7QUFDbkJGLFFBQUFBLGFBQWEsQ0FBQ0UsR0FBZCxDQUFrQnNELEtBQWxCLENBQXdCLGdEQUFnREQsRUFBeEU7QUFDSDs7QUFDRHRELE1BQUFBLFFBQVEsQ0FBQyxLQUFELENBQVI7QUFDSDtBQUNKOztBQTFKZ0I7O2VBNkpOSCxhIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmNvbnN0IEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyk7XHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuY29uc3QgYmFzZTY0SW1nID0gcmVxdWlyZSgnYmFzZTY0LWltZycpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdAbG9nNGpzLW5vZGUvbG9nNGpzLWFwaScpO1xyXG5cclxuY29uc3QgbW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cCA9IHJlcXVpcmUoXCJtb21lbnQtZHVyYXRpb24tZm9ybWF0XCIpO1xyXG5tb21lbnREdXJhdGlvbkZvcm1hdFNldHVwKG1vbWVudCk7XHJcblxyXG5jbGFzcyBIdG1sR2VuZXJhdG9yICB7XHJcblxyXG4gICAgc3RhdGljIGh0bWxPdXRwdXQocmVwb3J0T3B0aW9ucywgY2FsbGJhY2sgPSAoKSA9Pnt9KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKHJlcG9ydE9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRPcHRpb25zLkxPRy5kZWJ1ZyhcIkh0bWwgR2VuZXJhdGlvbiBzdGFydGVkXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmMocmVwb3J0T3B0aW9ucy50ZW1wbGF0ZUZpbGVuYW1lLCAndXRmOCcpO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaW1hZ2VBc0Jhc2U2NCcsIGZ1bmN0aW9uIChzY3JlZW5zaG90RmlsZSwgc2NyZWVuc2hvdFBhdGgsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgLy8gb2NjdXJzIHdoZW4gdGhlcmUgaXMgYW4gZXJyb3IgZmlsZVxyXG4gICAgICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHNjcmVlbnNob3RGaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzY3JlZW5zaG90UGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zaG90RmlsZSA9IGAke3NjcmVlbnNob3RQYXRofS8ke3NjcmVlbnNob3RGaWxlfWBcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zaG90RmlsZSA9IGAke3NjcmVlbnNob3RGaWxlfWBcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYmFzZTY0SW1nLmJhc2U2NFN5bmMocGF0aC5yZXNvbHZlKGAke3NjcmVlbnNob3RGaWxlfWApKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHtkYXRhfWA7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpc1ZhbGlkUmVwb3J0JywgZnVuY3Rpb24gKHN1aXRlcywgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3VpdGVzICYmIHN1aXRlcy5sZW5ndGggPiAwICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpc1ZhbGlkU3VpdGUnLCBmdW5jdGlvbiAoc3VpdGUsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN1aXRlLnRpdGxlLmxlbmd0aCA+IDAgJiZcclxuICAgICAgICAgICAgICAgICAgICBzdWl0ZS50eXBlID09PSAnc3VpdGUnICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc3VpdGUudGVzdHMubGVuZ3RoID4gMCApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3Rlc3RTdGF0ZUNvbG91cicsIGZ1bmN0aW9uIChzdGF0ZSwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09ICdwYXNzZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LXBhc3MnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ2ZhaWxlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3QtZmFpbCc7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAncGVuZGluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3QtcGVuZGluZyc7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnc2tpcHBlZCcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1za2lwcGVkJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3Rlc3RTdGF0ZUljb24nLCBmdW5jdGlvbiAoc3RhdGUsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlID09PSAncGFzc2VkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJzdWNjZXNzXCI+JiMxMDAwNDs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnZmFpbGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJlcnJvclwiPiYjMTAwMDY7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3BlbmRpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cInBlbmRpbmdcIj4mIzEwMDA0Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdza2lwcGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJza2lwcGVkXCI+JiMxMDAzNDs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignc3VpdGVTdGF0ZUNvbG91cicsIGZ1bmN0aW9uICh0ZXN0cywgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbnVtVGVzdHMgPSBPYmplY3Qua2V5cyh0ZXN0cykubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBmYWlsID0gXy52YWx1ZXModGVzdHMpLmZpbmQoKHRlc3QpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVzdC5zdGF0ZSA9PT0gJ2ZhaWxlZCc7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgaWYgKGZhaWwgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnc3VpdGUtZmFpbCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHBhc3NlcyA9IF8udmFsdWVzKHRlc3RzKS5maWx0ZXIoKHRlc3QpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVzdC5zdGF0ZSA9PT0gJ3Bhc3NlZCc7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgaWYgKHBhc3Nlcy5sZW5ndGggPT09IG51bVRlc3RzICYmIG51bVRlc3RzID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnc3VpdGUtcGFzcyc7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy9za2lwcGVkIGlzIHRoZSBsb3dlc3QgcHJpb3JpdHkgY2hlY2tcclxuICAgICAgICAgICAgICAgIGxldCBza2lwcGVkID0gXy52YWx1ZXModGVzdHMpLmZpbmQoKHRlc3QpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGVzdC5zdGF0ZSA9PT0gJ3NraXBwZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChza2lwcGVkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXBlbmRpbmcnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiAnc3VpdGUtdW5rbm93bidcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdodW1hbml6ZUR1cmF0aW9uJywgZnVuY3Rpb24gKGR1cmF0aW9uLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oZHVyYXRpb24sIFwibWlsbGlzZWNvbmRzXCIpLmZvcm1hdCgnaGg6bW06c3MuU1MnLCB7dHJpbTogZmFsc2V9KVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmU3VpdGVIYXNUZXN0cycsIGZ1bmN0aW9uICh0ZXN0c0hhc2gsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKHRlc3RzSGFzaCkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcylcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZFdmVudElzRXJyb3InLCBmdW5jdGlvbiAoZXZlbnQsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUuaW5jbHVkZXMoJ0Vycm9yJykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc1NjcmVlbnNob3QnLCBmdW5jdGlvbiAoZXZlbnQsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICdzY3JlZW5zaG90Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuZm4odGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaWZFdmVudElzTG9nTWVzc2FnZScsIGZ1bmN0aW9uIChldmVudCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2xvZycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZ0NsYXNzJywgZnVuY3Rpb24gKHRleHQgLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0ZXh0LmluY2x1ZGVzKCdUZXN0IEl0ZXJhdGlvbicpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwidGVzdC1pdGVyYXRpb25cIjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwibG9nLW91dHB1dFwiO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlcG9ydE9wdGlvbnMudGVtcGxhdGVGdW5jcykuZm9yRWFjaCgoa2V5KT0+e1xyXG4gICAgICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcihrZXksIHJlcG9ydE9wdGlvbnMudGVtcGxhdGVGdW5jc1trZXldKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoZnMucGF0aEV4aXN0c1N5bmMocmVwb3J0T3B0aW9ucy5vdXRwdXREaXIpKSB7XHJcbiAgICAgICAgICAgICAgIGxldCBqc29uRmlsZSA9IHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZS5yZXBsYWNlKCcuaHRtbCcgLCAnLmpzb24nKSA7XHJcbiAgICAgICAgICAgICAgICAgICAgZnMub3V0cHV0RmlsZVN5bmMoanNvbkZpbGUsIEpTT04uc3RyaW5naWZ5KHJlcG9ydE9wdGlvbnMuZGF0YSkpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgdGVtcGxhdGUgPSBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGVGaWxlKTtcclxuICAgICAgICAgICAgbGV0IGh0bWwgPSB0ZW1wbGF0ZShyZXBvcnRPcHRpb25zLmRhdGEpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZzLnBhdGhFeGlzdHNTeW5jKHJlcG9ydE9wdGlvbnMub3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICAgZnMub3V0cHV0RmlsZVN5bmMocmVwb3J0T3B0aW9ucy5yZXBvcnRGaWxlLCBodG1sKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmRlYnVnKFwiSHRtbCBHZW5lcmF0aW9uIGNvbXBsZXRlZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYWxsYmFjayh0cnVlKTtcclxuICAgICAgICB9IGNhdGNoKGV4KSB7XHJcbiAgICAgICAgICAgIGlmIChyZXBvcnRPcHRpb25zLkxPRykge1xyXG4gICAgICAgICAgICAgICAgcmVwb3J0T3B0aW9ucy5MT0cuZXJyb3IoXCJIdG1sIEdlbmVyYXRpb24gcHJvY2Vzc2luZyBlbmRlZCBpbiBlcnJvcjogXCIgKyBleCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgSHRtbEdlbmVyYXRvcjtcclxuIl19