"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _reporter = _interopRequireDefault(require("@wdio/reporter"));

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

const log4js = require('@log4js-node/log4js-api');

const logger = log4js.getLogger('default');

const ReportEvents = require("@rpii/wdio-report-events");

let proxy = new ReportEvents.default();

class HtmlReporter extends _reporter.default {
  constructor(opts) {
    opts = Object.assign({}, {
      stdout: true,
      outputDir: 'reports/html-reports/',
      filename: 'report.html',
      templateFilename: path.resolve(__dirname, '../templates/wdio-html-reporter-template.hbs'),
      templateFuncs: {},
      reportTitle: 'Test Report Title',
      showInBrowser: false,
      useOnAfterCommandForScreenshot: true,
      LOG: null
    }, opts);
    super(opts);
    this.options = opts;

    if (!this.options.LOG) {
      this.options.LOG = logger;
    }

    const dir = this.options.outputDir + 'screenshots';
    fs.ensureDirSync(dir);
    this.suiteUids = [];
    this.suites = [];
    this.indents = 0;
    this.suiteIndents = {};
    this.metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: 0,
      end: 0,
      duration: 0
    };
    this.openInProgress = false;
    this.defaultTestIndent = '   ';
    proxy.connectMessageEvent(this.saveMessage.bind(this));
    proxy.connectScreenshotEvent(this.saveScreenshot.bind(this));
  }

  get isSynchronised() {
    return !this.openInProgress;
  }

  onRunnerStart(runner) {
    this.log("onRunnerStart: ", JSON.stringify(runner)); //todo look at fix, not async safe. but one cid per report file

    this.cid = runner.cid;
    this.metrics.passed = 0;
    this.metrics.skipped = 0;
    this.metrics.failed = 0;
  }

  onSuiteStart(suite) {
    this.suiteUids.push(suite.uid);
    this.suiteIndents[suite.uid] = ++this.indents;
    this.suiteUid = suite.uid;
    let thisSuite = Object.assign({}, suite);
    thisSuite.type = 'suite';
    this.suites.push(thisSuite);
    this.log("onSuiteStart: ", JSON.stringify(thisSuite));
  }

  onTestStart(theTest) {
    this.log("onTestStart: ", JSON.stringify(theTest));
    this.testUid = theTest.uid;
    let test = this.getTest(theTest.uid);
    test.events = [];
    test.errorIndex = 0;
  }

  onTestPass(test) {
    this.log("onTestPass: ", JSON.stringify(test));
    this.metrics.passed++;
  }

  onTestSkip(test) {
    this.log("onTestSkip: ", JSON.stringify(test));
    this.metrics.skipped++;
  }

  onTestFail(test) {
    this.log("onTestFail: ", JSON.stringify(test));
    this.moveErrorsToEvents(test);
    this.metrics.failed++;
  }

  onHookEnd(hook) {
    if (hook.error) {
      this.metrics.failed++;
    }
  }

  onTestEnd(theTest) {
    this.log("onTestEnd: ", JSON.stringify(theTest));
    let test = this.getTest(theTest.uid);
    this.moveErrorsToEvents(test);
  }

  onSuiteEnd(suite) {
    this.log("onSuiteEnd: ", JSON.stringify(suite));
    this.indents--; // this is to display suite end time and duration in master report.

    for (const tsuite of this.suites) {
      if (tsuite.uid == suite.uid) {
        tsuite.end = suite.end;
        tsuite._duration = suite._duration;
        break;
      }
    }
  }

  isScreenshotCommand(command) {
    const isScreenshotEndpoint = /\/session\/[^/]*\/screenshot/;
    return isScreenshotEndpoint.test(command.endpoint);
  } //this is a hack to get around lack of onScreenshot event


  onAfterCommand(command) {
    if (this.options.useOnAfterCommandForScreenshot) {
      if (this.isScreenshotCommand(command) && command.result.value) {
        const timestamp = moment().format('YYYYMMDD-HHmmss.SSS');
        const filepath = path.join(this.options.outputDir, '/screenshots/', encodeURIComponent(this.cid), timestamp, this.options.filename + '.png');
        this.log("onAfterCommand: taking screenshot " + filepath);
        fs.outputFileSync(filepath, Buffer.from(command.result.value, 'base64'));
        let test = this.getTest(this.testUid);
        test.events.push({
          type: 'screenshot',
          value: filepath
        });
      }
    }
  }

  log(message, object) {
    if (this.options.LOG || this.options.debug) {
      this.options.LOG.debug(message + object);
    }
  }

  getSuite(uid) {
    for (let i = 0; i < this.suites.length; i++) {
      if (uid === this.suites[i].uid) {
        return this.suites[i];
      }
    }

    return null;
  }

  getTest(uid) {
    let suite = this.getSuite(this.suiteUid);

    for (let i = 0; i < suite.tests.length; i++) {
      if (uid === suite.tests[i].uid) {
        return suite.tests[i];
      }
    }

    return null;
  } //this is a hack.  we have to move all the things in test.errors before they get blown away


  moveErrorsToEvents(test) {
    if (test.errors) {
      for (let i = test.errorIndex; i < test.errors.length; i++) {
        test.events.push({
          type: 'Error',
          ...test.errors[i]
        });
      }

      test.errorIndex = test.errors.length;
    }
  }

  saveScreenshot(filepath) {
    let test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'screenshot',
      value: filepath
    });
  }

  saveMessage(message) {
    const test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'log',
      value: message
    });
  }

  getOrderedSuites() {
    if (this.orderedSuites) {
      return this.orderedSuites;
    }

    this.orderedSuites = [];

    for (const uid of this.suiteUids) {
      for (const suite of this.suites) {
        if (suite.uid !== uid) {
          continue;
        }

        this.orderedSuites.push(suite);
      }
    }

    return this.orderedSuites;
  } // convert to a style class


  indent(uid) {
    const indents = this.suiteIndents[uid];
    return indents === 0 ? '' : Array(indents).join('    ');
  }

  onRunnerEnd(runner) {
    let self = this;
    this.log("onRunnerEnd: ", JSON.stringify(runner));
    self.openInProgress = true;
    self.metrics.start = runner.start;
    self.metrics.end = runner.end;
    self.metrics.duration = runner._duration;

    if (!self.suiteUid) {
      self.suiteUid = "suite";
    }

    if (!self.cid) {
      self.cid = "cid";
    }

    const reportOptions = {
      data: {
        info: runner,
        metrics: self.metrics,
        suites: self.getOrderedSuites(),
        title: self.options.reportTitle
      },
      showInBrowser: self.options.showInBrowser,
      outputDir: self.options.outputDir,
      reportFile: path.join(process.cwd(), self.options.outputDir, encodeURIComponent(self.suiteUid), encodeURIComponent(self.cid), self.options.filename),
      templateFilename: self.options.templateFilename,
      templateFuncs: self.options.templateFuncs
    };

    _htmlGenerator.default.htmlOutput(reportOptions, () => {
      self.openInProgress = false;
    });
  }

}

var _default = HtmlReporter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRlci5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJfIiwicGF0aCIsIm1vbWVudCIsIm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAiLCJsb2c0anMiLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJSZXBvcnRFdmVudHMiLCJwcm94eSIsImRlZmF1bHQiLCJIdG1sUmVwb3J0ZXIiLCJXRElPUmVwb3J0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzdGRvdXQiLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidGVtcGxhdGVGdW5jcyIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsInVzZU9uQWZ0ZXJDb21tYW5kRm9yU2NyZWVuc2hvdCIsIkxPRyIsIm9wdGlvbnMiLCJkaXIiLCJlbnN1cmVEaXJTeW5jIiwic3VpdGVVaWRzIiwic3VpdGVzIiwiaW5kZW50cyIsInN1aXRlSW5kZW50cyIsIm1ldHJpY3MiLCJwYXNzZWQiLCJza2lwcGVkIiwiZmFpbGVkIiwic3RhcnQiLCJlbmQiLCJkdXJhdGlvbiIsIm9wZW5JblByb2dyZXNzIiwiZGVmYXVsdFRlc3RJbmRlbnQiLCJjb25uZWN0TWVzc2FnZUV2ZW50Iiwic2F2ZU1lc3NhZ2UiLCJiaW5kIiwiY29ubmVjdFNjcmVlbnNob3RFdmVudCIsInNhdmVTY3JlZW5zaG90IiwiaXNTeW5jaHJvbmlzZWQiLCJvblJ1bm5lclN0YXJ0IiwicnVubmVyIiwibG9nIiwiSlNPTiIsInN0cmluZ2lmeSIsImNpZCIsIm9uU3VpdGVTdGFydCIsInN1aXRlIiwicHVzaCIsInVpZCIsInN1aXRlVWlkIiwidGhpc1N1aXRlIiwidHlwZSIsIm9uVGVzdFN0YXJ0IiwidGhlVGVzdCIsInRlc3RVaWQiLCJ0ZXN0IiwiZ2V0VGVzdCIsImV2ZW50cyIsImVycm9ySW5kZXgiLCJvblRlc3RQYXNzIiwib25UZXN0U2tpcCIsIm9uVGVzdEZhaWwiLCJtb3ZlRXJyb3JzVG9FdmVudHMiLCJvbkhvb2tFbmQiLCJob29rIiwiZXJyb3IiLCJvblRlc3RFbmQiLCJvblN1aXRlRW5kIiwidHN1aXRlIiwiX2R1cmF0aW9uIiwiaXNTY3JlZW5zaG90Q29tbWFuZCIsImNvbW1hbmQiLCJpc1NjcmVlbnNob3RFbmRwb2ludCIsImVuZHBvaW50Iiwib25BZnRlckNvbW1hbmQiLCJyZXN1bHQiLCJ2YWx1ZSIsInRpbWVzdGFtcCIsImZvcm1hdCIsImZpbGVwYXRoIiwiam9pbiIsImVuY29kZVVSSUNvbXBvbmVudCIsIm91dHB1dEZpbGVTeW5jIiwiQnVmZmVyIiwiZnJvbSIsIm1lc3NhZ2UiLCJvYmplY3QiLCJkZWJ1ZyIsImdldFN1aXRlIiwiaSIsImxlbmd0aCIsInRlc3RzIiwiZXJyb3JzIiwiZ2V0T3JkZXJlZFN1aXRlcyIsIm9yZGVyZWRTdWl0ZXMiLCJpbmRlbnQiLCJBcnJheSIsIm9uUnVubmVyRW5kIiwic2VsZiIsInJlcG9ydE9wdGlvbnMiLCJkYXRhIiwiaW5mbyIsInRpdGxlIiwicmVwb3J0RmlsZSIsInByb2Nlc3MiLCJjd2QiLCJIdG1sR2VuZXJhdG9yIiwiaHRtbE91dHB1dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1BQU1DLENBQUMsR0FBR0QsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxNQUFNLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1JLHlCQUF5QixHQUFHSixPQUFPLENBQUMsd0JBQUQsQ0FBekM7O0FBQ0FJLHlCQUF5QixDQUFDRCxNQUFELENBQXpCOztBQUNBLE1BQU1FLE1BQU0sR0FBR0wsT0FBTyxDQUFDLHlCQUFELENBQXRCOztBQUNBLE1BQU1NLE1BQU0sR0FB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SDtBQUVIaEIsUUFBQUEsT0FBTyxFQUFFMEUsSUFBSSxDQUFDMUUsT0FGWDtBQUdISCxRQUFBQSxNQUFNLEVBQUU2RSxJQUFJLENBQUNMLGdCQUFMLEVBSEw7QUFJSFMsUUFBQUEsS0FBSyxFQUFFSixJQUFJLENBQUNqRixPQUFMLENBQWFKO0FBSmpCLE9BRFc7QUFPbEJDLE1BQUFBLGFBQWEsRUFBR29GLElBQUksQ0FBQ2pGLE9BQUwsQ0FBYUgsYUFQWDtBQVFsQlAsTUFBQUEsU0FBUyxFQUFHMkYsSUFBSSxDQUFDakYsT0FBTCxDQUFhVixTQVJQO0FBU2xCZ0csTUFBQUEsVUFBVSxFQUFHaEgsSUFBSSxDQUFDeUYsSUFBTCxDQUFVd0IsT0FBTyxDQUFDQyxHQUFSLEVBQVYsRUFBeUJQLElBQUksQ0FBQ2pGLE9BQUwsQ0FBYVYsU0FBdEMsRUFBaUQwRSxrQkFBa0IsQ0FBQ2lCLElBQUksQ0FBQ2pELFFBQU4sQ0FBbkUsRUFBcUZnQyxrQkFBa0IsQ0FBQ2lCLElBQUksQ0FBQ3RELEdBQU4sQ0FBdkcsRUFBbUhzRCxJQUFJLENBQUNqRixPQUFMLENBQWFULFFBQWhJLENBVEs7QUFVbEJDLE1BQUFBLGdCQUFnQixFQUFFeUYsSUFBSSxDQUFDakYsT0FBTCxDQUFhUixnQkFWYjtBQVdsQkcsTUFBQUEsYUFBYSxFQUFFc0YsSUFBSSxDQUFDakYsT0FBTCxDQUFhTDtBQVhWLEtBQXRCOztBQWFBOEYsMkJBQWNDLFVBQWQsQ0FBeUJSLGFBQXpCLEVBQXVDLE1BQU07QUFDekNELE1BQUFBLElBQUksQ0FBQ25FLGNBQUwsR0FBc0IsS0FBdEI7QUFDSCxLQUZEO0FBR0g7O0FBN09tQzs7ZUFpUHpCL0IsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXRElPUmVwb3J0ZXIgZnJvbSAnQHdkaW8vcmVwb3J0ZXInXHJcbmltcG9ydCBIdG1sR2VuZXJhdG9yIGZyb20gJy4vaHRtbEdlbmVyYXRvcidcclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuY29uc3QgbW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cCA9IHJlcXVpcmUoXCJtb21lbnQtZHVyYXRpb24tZm9ybWF0XCIpO1xyXG5tb21lbnREdXJhdGlvbkZvcm1hdFNldHVwKG1vbWVudCk7XHJcbmNvbnN0IGxvZzRqcyA9IHJlcXVpcmUoJ0Bsb2c0anMtbm9kZS9sb2c0anMtYXBpJyk7XHJcbmNvbnN0IGxvZ2dlciA9IGxvZzRqcy5nZXRMb2dnZXIoJ2RlZmF1bHQnKTtcclxuY29uc3QgUmVwb3J0RXZlbnRzICA9IHJlcXVpcmUoXCJAcnBpaS93ZGlvLXJlcG9ydC1ldmVudHNcIikgO1xyXG5sZXQgcHJveHkgPSBuZXcgUmVwb3J0RXZlbnRzLmRlZmF1bHQoKSA7XHJcblxyXG5jbGFzcyBIdG1sUmVwb3J0ZXIgZXh0ZW5kcyBXRElPUmVwb3J0ZXIge1xyXG5cclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRzKSB7XHJcbiAgICAgICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIHtcclxuICAgICAgICAgICAgc3Rkb3V0OiB0cnVlLFxyXG4gICAgICAgICAgICBvdXRwdXREaXI6ICdyZXBvcnRzL2h0bWwtcmVwb3J0cy8nLFxyXG4gICAgICAgICAgICBmaWxlbmFtZTogJ3JlcG9ydC5odG1sJyxcclxuICAgICAgICAgICAgdGVtcGxhdGVGaWxlbmFtZTogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uL3RlbXBsYXRlcy93ZGlvLWh0bWwtcmVwb3J0ZXItdGVtcGxhdGUuaGJzJyksXHJcbiAgICAgICAgICAgIHRlbXBsYXRlRnVuY3M6IHt9LFxyXG4gICAgICAgICAgICByZXBvcnRUaXRsZTogJ1Rlc3QgUmVwb3J0IFRpdGxlJyxcclxuICAgICAgICAgICAgc2hvd0luQnJvd3NlcjogZmFsc2UsXHJcbiAgICAgICAgICAgIHVzZU9uQWZ0ZXJDb21tYW5kRm9yU2NyZWVuc2hvdDogdHJ1ZSxcclxuICAgICAgICAgICAgTE9HIDogbnVsbFxyXG4gICAgICAgIH0sIG9wdHMpO1xyXG4gICAgICAgIHN1cGVyKG9wdHMpO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdHM7XHJcbiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5MT0cgPSBsb2dnZXI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRpciA9IHRoaXMub3B0aW9ucy5vdXRwdXREaXIgKyAnc2NyZWVuc2hvdHMnIDtcclxuXHJcbiAgICAgICAgZnMuZW5zdXJlRGlyU3luYyhkaXIpIDtcclxuICAgICAgICB0aGlzLnN1aXRlVWlkcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuc3VpdGVzID0gW107XHJcbiAgICAgICAgdGhpcy5pbmRlbnRzID0gMDtcclxuICAgICAgICB0aGlzLnN1aXRlSW5kZW50cyA9IHt9O1xyXG4gICAgICAgIHRoaXMubWV0cmljcyA9IHtcclxuICAgICAgICAgICAgcGFzc2VkIDogMCxcclxuICAgICAgICAgICAgc2tpcHBlZCA6IDAsXHJcbiAgICAgICAgICAgIGZhaWxlZCA6IDAsXHJcbiAgICAgICAgICAgIHN0YXJ0OiAwLFxyXG4gICAgICAgICAgICBlbmQ6IDAgLFxyXG4gICAgICAgICAgICBkdXJhdGlvbjowXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLm9wZW5JblByb2dyZXNzID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5kZWZhdWx0VGVzdEluZGVudCA9ICcgICAnIDtcclxuICAgICAgICBwcm94eS5jb25uZWN0TWVzc2FnZUV2ZW50KHRoaXMuc2F2ZU1lc3NhZ2UuYmluZCh0aGlzKSk7XHJcbiAgICAgICAgcHJveHkuY29ubmVjdFNjcmVlbnNob3RFdmVudCh0aGlzLnNhdmVTY3JlZW5zaG90LmJpbmQodGhpcykpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBnZXQgaXNTeW5jaHJvbmlzZWQgKCkge1xyXG4gICAgICAgIHJldHVybiAhdGhpcy5vcGVuSW5Qcm9ncmVzcyA7XHJcbiAgICB9XHJcblxyXG4gICAgb25SdW5uZXJTdGFydChydW5uZXIpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uUnVubmVyU3RhcnQ6IFwiICwgSlNPTi5zdHJpbmdpZnkocnVubmVyKSk7XHJcbiAgICAgICAgLy90b2RvIGxvb2sgYXQgZml4LCBub3QgYXN5bmMgc2FmZS4gYnV0IG9uZSBjaWQgcGVyIHJlcG9ydCBmaWxlXHJcbiAgICAgICAgdGhpcy5jaWQgPSBydW5uZXIuY2lkO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5wYXNzZWQgPSAwO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5za2lwcGVkID0gMDtcclxuICAgICAgICB0aGlzLm1ldHJpY3MuZmFpbGVkID0gMDtcclxuICAgIH1cclxuXHJcbiAgICBvblN1aXRlU3RhcnQoc3VpdGUpIHtcclxuICAgICAgICB0aGlzLnN1aXRlVWlkcy5wdXNoKHN1aXRlLnVpZCk7XHJcbiAgICAgICAgdGhpcy5zdWl0ZUluZGVudHNbc3VpdGUudWlkXSA9ICsrdGhpcy5pbmRlbnRzO1xyXG4gICAgICAgIHRoaXMuc3VpdGVVaWQgPSBzdWl0ZS51aWQ7XHJcbiAgICAgICAgbGV0IHRoaXNTdWl0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN1aXRlKTtcclxuICAgICAgICB0aGlzU3VpdGUudHlwZSA9ICdzdWl0ZSc7XHJcbiAgICAgICAgdGhpcy5zdWl0ZXMucHVzaCh0aGlzU3VpdGUpO1xyXG4gICAgICAgIHRoaXMubG9nKFwib25TdWl0ZVN0YXJ0OiBcIiwgSlNPTi5zdHJpbmdpZnkodGhpc1N1aXRlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25UZXN0U3RhcnQodGhlVGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0U3RhcnQ6IFwiICwgSlNPTi5zdHJpbmdpZnkodGhlVGVzdCkpO1xyXG4gICAgICAgIHRoaXMudGVzdFVpZCA9IHRoZVRlc3QudWlkIDtcclxuICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGVUZXN0LnVpZCkgO1xyXG4gICAgICAgIHRlc3QuZXZlbnRzID0gW107XHJcbiAgICAgICAgdGVzdC5lcnJvckluZGV4ID0gMCA7XHJcbiAgICB9XHJcblxyXG4gICAgb25UZXN0UGFzcyh0ZXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblRlc3RQYXNzOiBcIiAsIEpTT04uc3RyaW5naWZ5KHRlc3QpKTtcclxuICAgICAgICB0aGlzLm1ldHJpY3MucGFzc2VkKys7XHJcbiAgICB9XHJcblxyXG4gICAgb25UZXN0U2tpcCh0ZXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblRlc3RTa2lwOiBcIiAsIEpTT04uc3RyaW5naWZ5KHRlc3QpKTtcclxuICAgICAgICB0aGlzLm1ldHJpY3Muc2tpcHBlZCsrO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdEZhaWwodGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0RmFpbDogXCIgLCBKU09OLnN0cmluZ2lmeSh0ZXN0KSk7XHJcbiAgICAgICAgdGhpcy5tb3ZlRXJyb3JzVG9FdmVudHModGVzdCk7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLmZhaWxlZCsrO1xyXG4gICAgfVxyXG5cclxuICAgIG9uSG9va0VuZChob29rKSB7XHJcbiAgICAgICAgaWYgKGhvb2suZXJyb3IpIHtcclxuICAgICAgICAgICAgdGhpcy5tZXRyaWNzLmZhaWxlZCsrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG9uVGVzdEVuZCh0aGVUZXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblRlc3RFbmQ6IFwiICwgSlNPTi5zdHJpbmdpZnkodGhlVGVzdCkpO1xyXG4gICAgICAgIGxldCB0ZXN0ID0gdGhpcy5nZXRUZXN0KHRoZVRlc3QudWlkKSA7XHJcbiAgICAgICAgdGhpcy5tb3ZlRXJyb3JzVG9FdmVudHModGVzdCkgO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU3VpdGVFbmQoc3VpdGUpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uU3VpdGVFbmQ6IFwiICwgSlNPTi5zdHJpbmdpZnkoc3VpdGUpKTtcclxuICAgICAgICB0aGlzLmluZGVudHMtLTtcclxuICAgICAgICAvLyB0aGlzIGlzIHRvIGRpc3BsYXkgc3VpdGUgZW5kIHRpbWUgYW5kIGR1cmF0aW9uIGluIG1hc3RlciByZXBvcnQuXHJcbiAgICAgICAgZm9yIChjb25zdCB0c3VpdGUgb2YgdGhpcy5zdWl0ZXMpIHtcclxuICAgICAgICAgICAgaWYgKHRzdWl0ZS51aWQgPT0gc3VpdGUudWlkKSB7XHJcbiAgICAgICAgICAgICAgICB0c3VpdGUuZW5kID0gc3VpdGUuZW5kO1xyXG4gICAgICAgICAgICAgICAgdHN1aXRlLl9kdXJhdGlvbiA9IHN1aXRlLl9kdXJhdGlvbjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlzU2NyZWVuc2hvdENvbW1hbmQoY29tbWFuZCkge1xyXG4gICAgICAgIGNvbnN0IGlzU2NyZWVuc2hvdEVuZHBvaW50ID0gL1xcL3Nlc3Npb25cXC9bXi9dKlxcL3NjcmVlbnNob3QvXHJcbiAgICAgICAgcmV0dXJuIGlzU2NyZWVuc2hvdEVuZHBvaW50LnRlc3QoY29tbWFuZC5lbmRwb2ludClcclxuICAgIH1cclxuXHJcbiAgICAvL3RoaXMgaXMgYSBoYWNrIHRvIGdldCBhcm91bmQgbGFjayBvZiBvblNjcmVlbnNob3QgZXZlbnRcclxuICAgIG9uQWZ0ZXJDb21tYW5kKGNvbW1hbmQpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnVzZU9uQWZ0ZXJDb21tYW5kRm9yU2NyZWVuc2hvdCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc1NjcmVlbnNob3RDb21tYW5kKGNvbW1hbmQpICYmIGNvbW1hbmQucmVzdWx0LnZhbHVlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGltZXN0YW1wID0gbW9tZW50KCkuZm9ybWF0KCdZWVlZTU1ERC1ISG1tc3MuU1NTJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlcGF0aCA9IHBhdGguam9pbih0aGlzLm9wdGlvbnMub3V0cHV0RGlyLCAnL3NjcmVlbnNob3RzLycsIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmNpZCksIHRpbWVzdGFtcCwgdGhpcy5vcHRpb25zLmZpbGVuYW1lICsgJy5wbmcnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKFwib25BZnRlckNvbW1hbmQ6IHRha2luZyBzY3JlZW5zaG90IFwiICsgZmlsZXBhdGgpO1xyXG4gICAgICAgICAgICAgICAgZnMub3V0cHV0RmlsZVN5bmMoZmlsZXBhdGgsIEJ1ZmZlci5mcm9tKGNvbW1hbmQucmVzdWx0LnZhbHVlLCAnYmFzZTY0JykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCB0ZXN0ID0gdGhpcy5nZXRUZXN0KHRoaXMudGVzdFVpZCk7XHJcbiAgICAgICAgICAgICAgICB0ZXN0LmV2ZW50cy5wdXNoKHt0eXBlOiAnc2NyZWVuc2hvdCcsIHZhbHVlOiBmaWxlcGF0aH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxvZyhtZXNzYWdlLG9iamVjdCkge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuTE9HIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyApIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRy5kZWJ1ZyhtZXNzYWdlICsgb2JqZWN0KSA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0U3VpdGUodWlkKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAgOyBpIDwgdGhpcy5zdWl0ZXMubGVuZ3RoIDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh1aWQgPT09IHRoaXMuc3VpdGVzW2ldLnVpZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3VpdGVzW2ldIDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRUZXN0KHVpZCkge1xyXG4gICAgICAgIGxldCBzdWl0ZSA9IHRoaXMuZ2V0U3VpdGUodGhpcy5zdWl0ZVVpZCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAgOyBpIDwgc3VpdGUudGVzdHMubGVuZ3RoIDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICh1aWQgPT09IHN1aXRlLnRlc3RzW2ldLnVpZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN1aXRlLnRlc3RzW2ldIDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvL3RoaXMgaXMgYSBoYWNrLiAgd2UgaGF2ZSB0byBtb3ZlIGFsbCB0aGUgdGhpbmdzIGluIHRlc3QuZXJyb3JzIGJlZm9yZSB0aGV5IGdldCBibG93biBhd2F5XHJcblxyXG4gICAgbW92ZUVycm9yc1RvRXZlbnRzKHRlc3QpIHtcclxuICAgICAgICBpZiAodGVzdC5lcnJvcnMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRlc3QuZXJyb3JJbmRleDsgaSA8IHRlc3QuZXJyb3JzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXN0LmV2ZW50cy5wdXNoKHt0eXBlOiAnRXJyb3InLCAuLi50ZXN0LmVycm9yc1tpXX0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRlc3QuZXJyb3JJbmRleCA9IHRlc3QuZXJyb3JzLmxlbmd0aDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVNjcmVlbnNob3QoZmlsZXBhdGgpIHtcclxuICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGlzLnRlc3RVaWQpIDtcclxuICAgICAgICB0aGlzLm1vdmVFcnJvcnNUb0V2ZW50cyh0ZXN0KSA7XHJcbiAgICAgICAgdGVzdC5ldmVudHMucHVzaCh7dHlwZTogJ3NjcmVlbnNob3QnLCB2YWx1ZTogZmlsZXBhdGh9KSA7XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZU1lc3NhZ2UobWVzc2FnZSkge1xyXG4gICAgICAgIGNvbnN0IHRlc3QgPSB0aGlzLmdldFRlc3QodGhpcy50ZXN0VWlkKTtcclxuICAgICAgICB0aGlzLm1vdmVFcnJvcnNUb0V2ZW50cyh0ZXN0KSA7XHJcbiAgICAgICAgdGVzdC5ldmVudHMucHVzaCh7dHlwZTogJ2xvZycsIHZhbHVlOiBtZXNzYWdlfSkgO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXRPcmRlcmVkU3VpdGVzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm9yZGVyZWRTdWl0ZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3JkZXJlZFN1aXRlcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMub3JkZXJlZFN1aXRlcyA9IFtdO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHVpZCBvZiB0aGlzLnN1aXRlVWlkcykge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHN1aXRlIG9mIHRoaXMuc3VpdGVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3VpdGUudWlkICE9PSB1aWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyZWRTdWl0ZXMucHVzaChzdWl0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLm9yZGVyZWRTdWl0ZXM7XHJcbiAgICB9XHJcblxyXG4vLyBjb252ZXJ0IHRvIGEgc3R5bGUgY2xhc3NcclxuICAgIGluZGVudCh1aWQpIHtcclxuICAgICAgICBjb25zdCBpbmRlbnRzID0gdGhpcy5zdWl0ZUluZGVudHNbdWlkXTtcclxuICAgICAgICByZXR1cm4gaW5kZW50cyA9PT0gMCA/ICcnIDogQXJyYXkoaW5kZW50cykuam9pbignICAgICcpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uUnVubmVyRW5kKHJ1bm5lcikge1xyXG4gICAgICAgIGxldCBzZWxmID0gdGhpcyA7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblJ1bm5lckVuZDogXCIgLCBKU09OLnN0cmluZ2lmeShydW5uZXIpKTtcclxuICAgICAgICBzZWxmLm9wZW5JblByb2dyZXNzID0gdHJ1ZTtcclxuICAgICAgICBzZWxmLm1ldHJpY3Muc3RhcnQgPSBydW5uZXIuc3RhcnQgO1xyXG4gICAgICAgIHNlbGYubWV0cmljcy5lbmQgPSBydW5uZXIuZW5kIDtcclxuICAgICAgICBzZWxmLm1ldHJpY3MuZHVyYXRpb24gPSBydW5uZXIuX2R1cmF0aW9uO1xyXG4gICAgICAgIGlmICghIHNlbGYuc3VpdGVVaWQpIHtcclxuICAgICAgICAgICAgc2VsZi5zdWl0ZVVpZCA9IFwic3VpdGVcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCEgc2VsZi5jaWQpIHtcclxuICAgICAgICAgICAgc2VsZi5jaWQgPSBcImNpZFwiIDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcmVwb3J0T3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgZGF0YSA6IHtcclxuICAgICAgICAgICAgICAgIGluZm86IHJ1bm5lcixcclxuICAgICAgICAgICAgICAgIG1ldHJpY3M6IHNlbGYubWV0cmljcyxcclxuICAgICAgICAgICAgICAgIHN1aXRlczogc2VsZi5nZXRPcmRlcmVkU3VpdGVzKCksXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogc2VsZi5vcHRpb25zLnJlcG9ydFRpdGxlXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXIgOiBzZWxmLm9wdGlvbnMuc2hvd0luQnJvd3NlcixcclxuICAgICAgICAgICAgb3V0cHV0RGlyIDogc2VsZi5vcHRpb25zLm91dHB1dERpcixcclxuICAgICAgICAgICAgcmVwb3J0RmlsZSA6IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBzZWxmLm9wdGlvbnMub3V0cHV0RGlyLCBlbmNvZGVVUklDb21wb25lbnQoc2VsZi5zdWl0ZVVpZCkgLCBlbmNvZGVVUklDb21wb25lbnQoc2VsZi5jaWQpLCBzZWxmLm9wdGlvbnMuZmlsZW5hbWUpLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiBzZWxmLm9wdGlvbnMudGVtcGxhdGVGaWxlbmFtZSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczogc2VsZi5vcHRpb25zLnRlbXBsYXRlRnVuY3MsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBIdG1sR2VuZXJhdG9yLmh0bWxPdXRwdXQocmVwb3J0T3B0aW9ucywoKSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGYub3BlbkluUHJvZ3Jlc3MgPSBmYWxzZSAgO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBIdG1sUmVwb3J0ZXI7XHJcbiJdfQ==